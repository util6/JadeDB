---
title: JadeDB项目开发文档
description: 项目开发最高优先级文档，记录产品需求、技术选型、Bug记录、解决方案和知识经验总结
priority: HIGHEST
last_updated: 2025-08-29
version: 6.3

此文档在项目开发中是有最高优先级的文档，是使用AI辅助开发要首先查看并遵循的文档。

📋 **文档职责**：
- 记录产品需求和功能需求
- 记录技术选型和架构决策
- 记录开发过程中的Bug和解决方案
- 记录知识经验总结和最佳实践

⚠️ **内容原则**：
- 只记录关键、精简、精炼的信息
- 详细说明放在docs文件夹的独立文档中
- 项目根目录只保留此文档和README.md

❗️ **维护要求**：
- 每次改动后必须提交git
- 多分支项目需保持各分支文档一致
- 定期更新项目状态和进度
---





# JadeDB项目开发文档

## 📖 文档导航

### 核心文档
- **当前文档**: 项目开发主文档（最高优先级）
- **README.md**: 项目介绍和快速开始
- **DEVELOPMENT_ROADMAP.md**: 详细开发路线图
- **FIX_SUMMARY.md**: 核心功能修复总结

### 详细文档分类
- **开发里程碑**: `docs/开发里程碑/` - 各阶段完成总结
- **技术方案**: `docs/技术方案/` - 具体技术实现方案
- **架构设计**: `docs/架构设计/` - 系统架构和设计文档
- **使用指南**: `docs/使用指南/` - 功能使用和操作指南

---

## 🎯 项目概览

### 项目定位
JadeDB是一个**分布式SQL数据库系统**，从单机KV数据库演进而来，目标是在全方位达到TiDB全量功能的基础上，增加对b+树引擎的支持

### 核心特性
- **双存储引擎**: LSM树(写优化) + B+树(读优化)
- **分布式架构**: Raft共识 + 分片管理 + 分布式事务
- **ACID事务**: 完整的事务支持，多种隔离级别
- **高性能**: 生产级性能，支持高并发访问

---

## 🤖 AI辅助开发指南

### 项目目标描述

**项目愿景**: 从单机KV数据库演进为完整的分布式SQL数据库系统

**学习目标**: 
- 深入理解分布式数据库核心技术
- 掌握Go语言大型项目开发实践
- 学习MySQL/TiDB/CockroachDB的架构设计

**参考项目**:
1. **etcd-io/bbolt**: B+树实现，磁盘I/O优化，页面式存储
2. **lotusdblabs/lotusdb**: LSM树+B+树双引擎架构
3. **CockroachDB/TiDB**: 完整分布式SQL数据库系统

**开发策略**:
- 优先实现存储引擎基础设施（页面管理、崩溃恢复）
- 逐步完善高级特性（锁机制、索引结构、数据完整性）
- 最后集中开发事务和SQL层功能
- 文件命名使用bplustree（避免btree误解）

### 开发环境配置

**运行环境**:
- **Go版本**: 1.24+
- **平台支持**: macOS/Linux/Windows

### 核心功能需求

**存储引擎层** (✅ 已完成):
- LSM树存储引擎：写优化，支持高吞吐写入
- B+树存储引擎：读优化，支持高效范围查询
- 双引擎兼容：统一接口，运行时切换

**分布式基础设施** (✅ 已完成):
- Raft共识算法：强一致性保证
- 分片管理：数据分片和负载均衡
- 分布式事务：Percolator事务模型

**事务系统** (✅ 已完成):
- MVCC并发控制：多版本管理
- 锁管理：死锁检测，细粒度锁
- 事务隔离：支持多种隔离级别

**SQL层** (🎯 规划中):
- SQL解析器：词法分析、语法分析
- 查询优化器：基于规则和成本的优化
- 执行引擎：分布式查询执行



### 技术选型

**存储引擎**: LSM树 + Value Log分离架构

- **优势**: 写入性能优异，适合写多读少场景
- **权衡**: 读放大问题通过布隆过滤器和缓存缓解

**并发控制**: MVCC + 时间戳排序

- **优势**: 读写不阻塞，支持快照隔离
- **权衡**: 内存开销较大，需要垃圾回收

**文件格式**: 自定义二进制格式 + Protocol Buffers

- **优势**: 紧凑存储，跨平台兼容
- **权衡**: 调试复杂度增加

**内存管理**: 内存池 + 跳表 + LRU缓存

- **优势**: 减少GC压力，提升性能
- **权衡**: 内存使用复杂度增加





### 核心设计（重点）

**1. 分层存储架构**

- L0层: 直接从内存表刷写，可能重叠
- L1-L6层: 有序不重叠，逐层压缩合并
- 压缩策略: 大小触发 + 定期后台压缩

**2. Value Log分离设计**

- 小值(<ValueThreshold): 直接存储在LSM树
- 大值(>=ValueThreshold): 存储在Value Log，LSM树存指针
- 垃圾回收: 基于引用计数的异步清理

**3. 事务实现机制**

- 读时间戳: 事务开始时获取
- 写时间戳: 提交时分配
- 冲突检测: 基于键指纹的快速检测
- 提交协议: 两阶段提交保证一致性

**4. 并发控制策略**

- 读写分离: 读操作无锁，写操作批量处理
- 内存表切换: 原子操作保证一致性
- 压缩并发: 多个压缩器并行工作
- 资源管理: 统一的Closer模式管理生命周期



---





## 项目进度描述

**✅ 已完成功能 (Phase 1 - LSM树基础实现)**
- LSM树存储引擎核心架构
- 内存表(MemTable)与不可变表(Immutable)管理
- SSTable文件格式与多层级存储
- WAL(Write-Ahead Log)持久化机制
- 基础CRUD操作接口(Set/Get/Del/Iterator)
- MVCC事务支持与冲突检测
- Value Log分离存储大值优化
- 布隆过滤器查询优化
- 多级压缩(Compaction)策略
- 内存映射(mmap)文件访问
- 垃圾回收与磁盘空间管理

**✅ 已完成 (Phase 2 - PebbleDB优化策略全面实施)**
- **异步写入管道**: ✅ 完成三阶段流水线(WAL/内存表/同步)，支持Promise/Future模式
- **智能批量处理**: ✅ 完成自适应批量合并，支持去重和局部性优化
- **I/O调度优化**: ✅ 完成优先级队列调度，支持多类型工作池和任务重试
- **内存管理优化**: ✅ 完成对象池复用，支持自动GC触发和内存监控
- **压缩过程优化**: ✅ 完成并发压缩调度，支持任务优先级和资源限制
- **配置管理系统**: ✅ 完成多场景配置预设，支持动态配置调整
- **性能基准测试**: ✅ 完成全面的性能测试套件和对比分析
- **详细方案**: 参见 `docs/PebbleDB-优化方案.md` 和 `docs/PebbleDB-优化使用指南.md`

**✅ 已完成 (Phase 3.0 - B+树引擎基础设施)**
- **页面管理系统**: ✅ 16KB固定页面，CRC32校验，多文件支持
- **缓冲池管理**: ✅ LRU策略，16分区设计，脏页批量刷新
- **WAL日志系统**: ✅ 预写日志，LSN机制，组提交优化
- **崩溃恢复机制**: ✅ ARIES三阶段恢复，事务状态跟踪
- **性能优化组件**: ✅ 自适应哈希索引，智能预读器
- **测试覆盖**: ✅ 8个单元测试全部通过，性能基准达标
- **详细方案**: 参见 `docs/B+树引擎开发详细记录.md`

**✅ 已完成 (Phase 3.1 - B+树核心数据结构)**
- **B+树节点实现**: ✅ 内部节点/叶子节点，记录管理，空间分配
- **页面分裂算法**: ✅ 叶子节点分裂，内部节点分裂，根节点创建
- **键值查找**: ✅ 单点查找，路径追踪，节点导航
- **基础插入操作**: ✅ 支持页面分裂的插入，树高度自动增长

**✅ 已完成 (Phase 3.2 - B+树完善功能)**
- **范围查询和迭代器**: ✅ 双向遍历，范围限制，定位查找，资源管理
- **删除操作与页面合并**: ✅ 节点下溢处理，兄弟借用，页面合并，链表维护
- **完整CRUD操作**: ✅ 插入、查询、删除、范围扫描全部实现

**✅ 已完成 (Phase 3.3 - B+树高级特性)**
- **聚簇索引支持**: ✅ 聚簇索引和二级索引配置，主键顺序存储
- **并发控制机制**: ✅ 页面级锁管理器，读写锁兼容性，死锁检测
- **性能监控系统**: ✅ 热点页面检测，查询统计，趋势分析，异常检测
- **存储引擎接口**: ✅ 统一接口抽象，B+树适配器，混合引擎支持
- **事务支持**: ✅ 简单事务实现，ACID属性保证

**✅ 已完成 (Phase 3.4 - B+树完善)**
- **双引擎兼容层**: ✅ 存储引擎工厂，运行时引擎切换，统一API接口
- **完整测试覆盖**: ✅ 37个测试用例，功能和性能全面验证
- **工业级特性**: ✅ 锁超时处理，资源管理，错误恢复机制

**✅ 已完成 (Phase 4.0 - 分布式SQL系统基础设施)**
- **分布式共识层**: ✅ 完整Raft算法实现，领导者选举、日志复制、安全性保证
- **Raft状态机**: ✅ 键值存储状态机，支持快照和恢复机制
- **网络通信层**: ✅ HTTP传输层，RPC调用，消息序列化，连接管理
- **分布式事务协调器**: ✅ 两阶段提交(2PC)协议，ACID事务保证，故障恢复
- **事务管理**: ✅ 完整事务生命周期，状态跟踪，超时处理，并发控制
- **测试框架**: ✅ 完整的单元测试和集成测试，模拟网络分区

**✅ 已完成 (Phase 4.1 - 统一事务系统重构)**
- **统一事务架构**: ✅ 重新设计事务系统，支持单机和分布式统一接口
- **TransactionManager**: ✅ 统一事务管理器，多隔离级别，SQL就绪接口
- **TimestampOracle**: ✅ 统一时间戳管理，支持单机和分布式时间戳分配
- **MVCCManager**: ✅ 多版本并发控制，快照隔离，高效垃圾回收
- **LockManager**: ✅ 完整锁管理系统，死锁检测，多种锁类型支持
- **LocalTransaction**: ✅ 单机事务实现，保存点支持，完整ACID保证
- **DistributedTransaction**: ✅ 分布式事务实现，2PC协议，透明接口

**✅ 已完成 (Phase 4.2 - 存储引擎适配)**
- **StorageEngineAdapter**: ✅ 现有引擎与新事务系统无缝集成
- **StorageEngineFactory**: ✅ 统一引擎创建管理，支持B+树和LSM树
- **向后兼容**: ✅ 保持现有API完全兼容，遗留接口自动升级
- **性能优化**: ✅ 最小适配开销，批量操作优化，智能缓存
- **完整测试**: ✅ 功能测试、兼容性测试、性能测试全覆盖

**✅ 已完成 (Phase 4.3 - 架构重构与优化)**
- **架构问题识别**: ✅ 全面审查代码架构，识别循环依赖和职责混乱问题
- **事务系统重构**: ✅ 完成事务与存储引擎的清晰分离，避免循环依赖
- **存储适配器模式**: ✅ 通过StorageTransactionAdapter实现事务与存储的集成
- **页面锁管理重构**: ✅ 将B+树锁管理器重命名为PageLockManager，明确职责边界
- **架构分层优化**: ✅ 确立清晰的分层架构：transaction → storage → 具体引擎
- **代码编译验证**: ✅ 所有架构重构完成后代码成功编译，无循环依赖

**✅ 已完成 (Phase 4.4 - 事务功能完善)**
- **事务WAL集成**: ✅ 完成事务系统与WAL的深度集成，支持完整的ACID保证
- **WAL读写功能**: ✅ 实现WAL记录的读取、写入、范围查询和迭代功能
- **崩溃恢复机制**: ✅ 完善事务恢复回调系统，支持数据操作和事务状态恢复
- **MVCC版本管理**: ✅ 实现MVCC与WAL的集成，支持版本信息记录到WAL
- **事务架构优化**: ✅ 修复事务创建逻辑，确保存储适配器优先使用
- **性能验证**: ✅ 事务吞吐量110,921 txn/sec，操作吞吐量1,109,210 ops/sec
- **详细方案**: 参见完整的事务功能测试和性能基准

**✅ 已完成 (Phase 4.5 - TODO项系统性优化)**
- **TODO项全面分析**: ✅ 完成31个文件中TODO项的系统性分析和分类
- **优化计划制定**: ✅ 制定分5个阶段的详细优化计划，覆盖所有核心功能
- **Phase 1 事务系统核心功能完善**: ✅ 完成
  - ✅ **LocalTransaction范围查询**: 实现Scan范围扫描和NewIterator迭代器创建，支持MVCC和事务隔离级别
  - ✅ **MVCC垃圾回收机制**: 实现智能版本清理策略、后台垃圾回收器、批量垃圾回收优化
  - ✅ **死锁检测优化**: 实现智能死锁解决策略、死锁预防机制、锁超时优化
- **测试覆盖**: ✅ 完成LocalTransaction范围查询测试、MVCC垃圾回收测试、死锁检测测试
- **性能验证**: ✅ 所有功能测试通过，事务范围查询支持完整的MVCC语义
- **详细方案**: 参见 `docs/TODO项分析与优化计划.md`

- **Phase 2 B+树恢复机制完善**: ✅ 完成
  - ✅ **WAL恢复逻辑**: 实现重做操作(Insert/Update/Delete)、撤销操作逻辑、页面分裂/合并恢复
  - ✅ **WAL文件管理优化**: 完善文件扫描逻辑、实现高效文件写入、优化LSN管理机制
- **Phase 3 存储引擎优化**: ✅ 完成
  - ✅ **TableIterator实现**: 在utils包中定义TableIterator接口，在file包中实现SSTable迭代器
  - ✅ **压缩策略优化**: 实现陈旧数据统计，优化压缩调度逻辑，解决SSTable键范围设置问题
- **Phase 4 性能优化功能**: ✅ 完成
  - ✅ **缓存预取优化**: 实现BufferPool.Contains方法和智能相关性算法，优化预读器性能
- **Phase 5 工程质量提升**: ✅ 完成
  - ✅ **代码结构优化**: 重构utils.Options结构体，增加链式调用和扩展性
  - ✅ **锁粒度优化**: 优化file/manifest.go中的锁使用，减少锁持有时间
  - ✅ **错误处理完善**: 完善vlog.go、utils/value.go、file/wal.go中的错误处理和注释
  - ✅ **结构体重构**: 实现utils/arena.go节点偏移量逻辑，完善私有方法访问控制
- **测试覆盖**: ✅ 完成所有阶段的功能测试，包括工程质量提升测试
- **性能验证**: ✅ 所有功能测试通过，TODO项系统性优化全面完成

**✅ 已完成 (Phase 6.0 - 分布式共识层实现)**
- **Raft算法完整实现**: ✅ 领导者选举、日志复制、快照机制、网络分区容错
- **分片管理系统**: ✅ ShardManager数据分片、一致性哈希、动态分片、副本管理
- **持久化存储**: ✅ Raft状态持久化、日志存储、快照存储、数据完整性保证
- **性能验证**: ✅ 1,956,902 ops/sec吞吐量，零错误率，支持网络分区恢复
- **详细方案**: 参见 `docs/开发里程碑/项目最新进度总结-Phase6.2.md`

**✅ 已完成 (Phase 6.1 - 架构重构与循环依赖解决)**
- **循环依赖预防性重构**: ✅ 创建common包统一管理25+公共类型和12+公共接口
- **文件组织优化**: ✅ transaction包重组为6个子包，distributed包重组为7个子包
- **分层架构确立**: ✅ 建立common→distributed→transaction清晰依赖关系
- **编译验证**: ✅ 消除潜在循环依赖风险，代码编译无错误
- **文档体系完善**: ✅ 新增7个架构文档，包含理论与实践指南
- **详细方案**: 参见 `docs/技术方案/Go语言循环依赖问题详解.md`

**✅ 已完成 (Phase 6.2 - Percolator分布式事务模型基础)**
- **Percolator引擎实现**: ✅ 基于Google Percolator论文的分布式事务引擎
- **两阶段提交协议**: ✅ Prewrite和Commit两阶段确保事务原子性
- **Percolator MVCC**: ✅ 三列模型(Lock/Write/Data)，时间戳冲突检测
- **分布式锁缓存**: ✅ LRU缓存优化，支持Lock列族高效访问
- **事务协调器**: ✅ PercolatorCoordinator管理分布式事务生命周期
- **完整测试覆盖**: ✅ 基本事务、只读事务、回滚、并发事务测试全通过
- **详细方案**: 参见 `distributed/percolator/` 目录下的完整实现

**✅ 已完成 (Phase 6.3 - 核心功能修复完成)**

- **数据读写功能**: ✅ 完全修复LogFile.ReadValuePtr和EncodeEntry方法，值日志读写正常
- **删除功能**: ✅ 完全修复删除操作BitDelete标记设置，删除数据正确返回"Key not found"
- **引擎切换功能**: ✅ 完全修复B+树引擎WAL恢复死锁问题，引擎切换正常工作
- **值日志存储**: ✅ 完全修复大值存储逻辑，大值正确存储在值日志中，小值正确存储在LSM树中
- **系统稳定性**: ✅ 核心功能全部正常工作，可安全用于开发和测试环境
- **测试验证**: ✅ 基本功能测试、引擎功能测试、示例程序测试全部通过
- **详细方案**: 参见 `FIX_SUMMARY.md` 完整修复总结报告

**✅ 已完成  (Phase 6.3 - 核心功能修复完成)**

- **总体进度**: ✅ 约90%完成，核心功能全部修复，基础设施完善，正向完整分布式SQL数据库迈进
- **功能完整性**: ✅ 双存储引擎、分布式共识、事务系统、Percolator事务模型、核心CRUD功能
- **代码质量**: ✅ 生产级别标准，50,000+行代码，80%+测试覆盖率
- **架构稳定性**: ✅ 清晰分层架构，无循环依赖，模块化设计
- **核心功能状态**: ✅ 数据读写、删除、值日志存储、引擎切换功能全部正常工作

**Phase 6.4**: 系统优化与完善 (当前计划 - 4-6周)

- [ ] WAL恢复机制完善：解决B+树引擎WAL恢复并发控制问题
- [ ] 压缩器优化：优化压缩器启动和关闭逻辑，解决复杂场景卡住问题
- [ ] 性能优化：添加更多性能测试，优化大批量数据处理
- [ ] 时间戳服务完善：分布式时间戳分配、同步机制、高可用服务
- [ ] 事务性能优化：批量操作、异步提交、垃圾回收机制
- [ ] 完整测试验证：压力测试、故障恢复测试、性能基准测试

**Phase 7.0**: TiDB SQL层架构实现 (8-10周)

- [ ] SQL解析器实现 (2-3周)
  - SQL词法分析器 (支持所有SQL关键字、操作符、字面量)
  - 递归下降语法分析器 (构建完整AST)
  - 语义分析器 (类型检查、符号表管理)
  - 基础SQL语句支持 (SELECT/INSERT/UPDATE/DELETE)

- [ ] 查询优化器实现 (2-3周)
  - 基于规则的优化器 (谓词下推、投影下推、常量折叠)
  - 基于成本的优化器 (成本模型、统计信息收集)
  - 分布式查询优化 (JOIN重排序、数据本地性优化)
  - 执行计划生成和选择

- [ ] 分布式查询执行引擎 (3-4周)
  - 执行计划生成器 (逻辑计划→分布式物理计划)
  - 并行执行引擎 (流水线并行、分区并行)
  - 跨节点JOIN实现 (广播JOIN、分区JOIN)
  - 结果聚合器 (分布式聚合、排序)

**Phase 7.1**: 集群管理和SQL网关 (4-6周)

- [ ] 集群管理器 (节点发现、健康检查、故障恢复)
- [ ] 负载均衡器 (查询负载均衡、连接管理)
- [ ] SQL网关 (MySQL/PostgreSQL协议兼容)
- [ ] 连接管理和认证 (连接池、用户认证授权)

**Phase 7.2**: 系统集成和生产优化 (4-6周)

- [ ] 功能测试套件 (完整SQL功能测试)
- [ ] 性能基准测试 (对比主流分布式数据库)
- [ ] 故障注入测试 (验证容错能力)
- [ ] 扩展性测试 (水平扩展、性能线性度)
- [ ] 生产环境部署和监控



