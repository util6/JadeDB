# JadeDB B+树存储引擎

JadeDB B+树存储引擎是一个高性能、工业级的B+树实现，专门为读密集型工作负载设计。本实现参考InnoDB的设计原理，提供完整的ACID事务支持、崩溃恢复和并发控制机制。

## 🎯 设计目标

- **InnoDB完整性标准**：达到MySQL InnoDB存储引擎的可靠性和完整性水平
- **读优化性能**：专门为读密集型工作负载优化，提供优秀的查询性能
- **工业级可靠性**：完整的崩溃恢复、数据完整性检查和并发控制
- **高并发支持**：支持多线程并发访问，细粒度锁机制
- **内存高效**：智能缓存管理，充分利用系统内存

## 🏗️ 核心架构

### 1. 页面管理系统 (Page Management)
- **固定页面大小**：16KB页面，与InnoDB保持一致
- **页面类型管理**：支持根页面、内部页面、叶子页面、溢出页面
- **空间管理**：高效的页面分配和回收机制
- **完整性保护**：页面校验和，检测数据损坏

### 2. 缓冲池 (Buffer Pool)
- **LRU缓存策略**：最近最少使用页面优先被替换
- **分区设计**：减少锁竞争，提高并发性能
- **脏页管理**：跟踪和批量刷新修改过的页面
- **预读机制**：智能预读相关页面，提高访问性能

### 3. WAL日志系统 (Write-Ahead Log)
- **预写日志**：所有修改必须先写日志再修改数据
- **顺序写入**：充分利用磁盘顺序写入性能
- **组提交**：批量提交多个事务，减少I/O开销
- **日志轮转**：自动管理日志文件的创建和删除

### 4. 崩溃恢复 (Crash Recovery)
- **ARIES算法**：Analysis、Redo、Undo三阶段恢复
- **LSN机制**：日志序列号确保恢复的正确性
- **幂等性**：重复执行恢复操作不会产生副作用
- **并行恢复**：支持多线程并行恢复

### 5. 性能优化组件
- **自适应哈希索引**：为热点查询提供O(1)访问性能
- **智能预读器**：预测性地加载可能访问的页面
- **访问模式检测**：自动识别顺序访问和随机访问模式

## 📁 文件结构

```
bplustree/
├── bplustree.go          # B+树主控制器
├── page.go               # 页面结构和操作
├── page_manager.go       # 页面管理器
├── buffer_pool.go        # 缓冲池管理
├── wal.go                # WAL日志系统
├── recovery.go           # 崩溃恢复管理器
├── adaptive_hash.go      # 自适应哈希索引
├── prefetcher.go         # 智能预读器
├── bplustree_test.go     # 单元测试
└── README.md             # 本文档
```

## 🚀 核心特性

### 1. 页面式存储
- 16KB固定页面大小，优化磁盘I/O
- 页面头部包含完整的元数据信息
- 支持页面校验和，检测数据损坏
- 页面类型管理，支持不同用途的页面

### 2. 高效缓存
- LRU缓存策略，智能页面替换
- 分区缓冲池，减少锁竞争
- 脏页批量刷新，提高写入性能
- 缓存命中率统计和监控

### 3. 完整的事务支持
- WAL预写日志，确保数据持久性
- ARIES恢复算法，保证崩溃恢复的正确性
- LSN机制，维护日志的时序关系
- 检查点机制，减少恢复时间

### 4. 并发控制
- 页面级读写锁，支持并发访问
- 分区设计，减少锁竞争
- 无锁读取优化，提高查询性能
- 死锁检测和处理

### 5. 性能优化
- 自适应哈希索引，热点数据O(1)访问
- 智能预读机制，减少磁盘I/O
- 访问模式检测，优化预读策略
- 内存预分配，减少分配开销

## 📊 性能特性

### 读性能优化
- B+树结构天然适合范围查询
- 自适应哈希索引提供O(1)点查询
- 智能预读减少磁盘访问延迟
- 高效的缓存机制提高命中率

### 写性能优化
- WAL顺序写入，充分利用磁盘性能
- 批量提交减少I/O次数
- 脏页批量刷新，提高写入效率
- 异步后台服务，不阻塞前台操作

### 并发性能
- 分区设计减少锁竞争
- 页面级锁粒度，支持高并发
- 无锁读取优化
- 多线程并行恢复

## 🔧 配置选项

```go
type BTreeOptions struct {
    // 存储配置
    WorkDir          string        // 工作目录
    PageSize         int           // 页面大小（默认16KB）
    MaxFileSize      int64         // 单个文件最大大小
    
    // 缓冲池配置
    BufferPoolSize   int           // 缓冲池大小（页面数量）
    BufferPoolPolicy string        // 缓冲池替换策略
    
    // 性能配置
    EnableAdaptiveHash bool         // 启用自适应哈希索引
    EnablePrefetch     bool         // 启用预读机制
    PrefetchSize       int          // 预读页面数量
    
    // 恢复配置
    WALBufferSize    int           // WAL缓冲区大小
    CheckpointInterval time.Duration // 检查点间隔
}
```

## 📈 统计信息

B+树引擎提供详细的运行统计信息：

- **页面统计**：总页面数、叶子页面数、内部页面数、空闲页面数
- **访问统计**：页面读写次数、缓存命中率
- **操作统计**：插入、更新、删除、查询次数
- **性能统计**：平均查找时间、树高度
- **事务统计**：事务总数、提交次数、回滚次数

## 🧪 测试覆盖

- **单元测试**：各个组件的基本功能测试
- **集成测试**：组件间协作测试
- **性能测试**：性能指标基准测试
- **压力测试**：极限情况测试
- **恢复测试**：崩溃恢复功能测试

## 🔄 开发状态

### ✅ 已完成 (Phase 1-2)
- [x] 页面管理系统
- [x] 缓冲池管理
- [x] WAL日志系统
- [x] 崩溃恢复机制
- [x] 自适应哈希索引
- [x] 智能预读器
- [x] 基础测试框架

### 🚧 进行中 (Phase 3)
- [ ] B+树核心结构实现
- [ ] 页面分裂与合并算法
- [ ] 聚簇索引实现
- [ ] 范围查询支持

### 📋 待实现 (Phase 4-6)
- [ ] 锁机制与并发控制
- [ ] 数据完整性检查
- [ ] 辅助索引支持
- [ ] 事务系统集成

## 🎯 适用场景

- **读多写少的应用**：B+树结构优化读取性能
- **需要范围查询**：天然支持高效的范围查询
- **事务一致性要求严格**：完整的ACID支持
- **需要复杂查询**：支持多种查询模式
- **高并发访问**：细粒度锁机制支持并发

## 🔗 相关文档

- [项目开发文档](../docs/项目开发文档-JadeDB.md)
- [B+树引擎设计文档](../docs/B+树引擎设计文档.md)
- [性能测试报告](../docs/性能测试报告.md)

---

**注意**：当前实现处于开发阶段，主要完成了页面管理、缓冲池、WAL和恢复等基础设施。B+树的核心数据结构和操作算法正在开发中。
